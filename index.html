<script>
  // Глобальные переменные для управления картой
  let myMap = null;
  let mapResizeTimeout = null;
  
  // Переменные для хранения данных формы перед отправкой
  let pendingFormData = null;

  // Управление мобильным меню
  const menuToggle = document.getElementById('menuToggle');
  const navLinks = document.getElementById('navLinks');
  const menuOverlay = document.getElementById('menuOverlay');
  
  if (menuToggle && navLinks) {
    // Открытие/закрытие меню
    menuToggle.addEventListener('click', function() {
      menuToggle.classList.toggle('active');
      navLinks.classList.toggle('active');
      menuOverlay.classList.toggle('active');
      document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
    });
    
    // Закрытие меню при клике на оверлей
    menuOverlay.addEventListener('click', function() {
      menuToggle.classList.remove('active');
      navLinks.classList.remove('active');
      menuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    });
    
    // Закрытие меню при клике на ссылку
    const navItems = navLinks.querySelectorAll('a');
    navItems.forEach(item => {
      item.addEventListener('click', function() {
        menuToggle.classList.remove('active');
        navLinks.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });
    });
    
    // Закрытие меню при изменении размера окна на десктоп
    window.addEventListener('resize', function() {
      if (window.innerWidth > 992) {
        menuToggle.classList.remove('active');
        navLinks.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
    
    // Закрытие меню по клавише Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && navLinks.classList.contains('active')) {
        menuToggle.classList.remove('active');
        navLinks.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  }

  // Упрощенная функция для обновления карты
  function updateMapSize() {
    if (!myMap) return;
    
    try {
      // Простое обновление размера карты
      myMap.container.fitToViewport();
    } catch (error) {
      console.error('Ошибка при обновлении карты:', error);
    }
  }

  // Функция инициализации карты
  function initMap() {
    // Проверяем, загрузился ли API Яндекс.Карт
    if (typeof ymaps === 'undefined') {
      console.error('Yandex Maps API не загрузился');
      document.getElementById('map').innerHTML = '<div class="map-placeholder">Карта временно недоступна</div>';
      return;
    }
    
    ymaps.ready(function() {
      // Координаты апартамента
      const apartmentCoords = [44.616622961342124, 33.517859032692016];
      
      try {
        // Создание карты
        myMap = new ymaps.Map('map', {
          center: apartmentCoords,
          zoom: 16,
          controls: ['zoomControl', 'fullscreenControl']
        });
        
        // Создание метки
        const myPlacemark = new ymaps.Placemark(apartmentCoords, {
          hintContent: 'Апартамент "Большая Терраса"',
          balloonContent: 'Апартамент "Большая Терраса"<br>набережная Адмирала Перелешина, 3<br>Севастополь'
        }, {
          // Используем стандартную метку
          preset: 'islands#redIcon'
        });
        
        // Добавление метки на карту
        myMap.geoObjects.add(myPlacemark);
        
        // Открываем балун при загрузке
        myPlacemark.balloon.open();
        
        // Отключаем скролл зум для мобильных
        if ('ontouchstart' in window) {
          myMap.behaviors.disable('scrollZoom');
        }
        
        // Настраиваем адаптацию карты
        setTimeout(function() {
          if (myMap) {
            myMap.container.fitToViewport();
          }
        }, 100);
        
      } catch (error) {
        console.error('Ошибка при создании карты:', error);
        document.getElementById('map').innerHTML = '<div class="map-placeholder">Ошибка загрузки карты</div>';
      }
    });
  }

  // Обработчик изменения размера окна с дебаунсингом (как в первом коде)
  window.addEventListener('resize', function() {
    clearTimeout(mapResizeTimeout);
    mapResizeTimeout = setTimeout(function() {
      updateMapSize();
    }, 250);
  });

  // Обработчик изменения ориентации (как в первом коде)
  window.addEventListener('orientationchange', function() {
    // Даем время на завершение анимации поворота
    setTimeout(function() {
      updateMapSize();
    }, 500);
  });

  // Lightbox и остальной код JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    // Инициализация карты при загрузке страницы
    initMap();
    
    // Элементы для управления видео
    const videoPreview = document.getElementById('videoPreview');
    const previewImage = videoPreview.querySelector('img');
    const playButton = document.getElementById('playButton');
    const videoModal = document.getElementById('videoModal');
    const videoModalContent = document.getElementById('videoModalContent');
    const videoModalClose = document.getElementById('videoModalClose');
    const apartmentVideo = document.getElementById('apartmentVideo');
    
    // Функция для получения размеров изображения
    function getImageSize() {
      const rect = previewImage.getBoundingClientRect();
      return {
        width: rect.width,
        height: rect.height
      };
    }
    
    // Открытие модального окна с видео
    function openVideoModal() {
      // Получаем размеры изображения
      const imageSize = getImageSize();
      
      // Устанавливаем размеры модального окна равными размерам изображения
      videoModalContent.style.width = imageSize.width + 'px';
      videoModalContent.style.height = imageSize.height + 'px';
      
      // Открываем модальное окно
      videoModal.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      // Автоматически запускаем видео при открытии
      setTimeout(() => {
        apartmentVideo.play().catch(error => {
          console.log('Автовоспроизведение не удалось:', error);
          // В случае ошибки автовоспроизведения показываем сообщение
          apartmentVideo.controls = true;
        });
      }, 300);
    }
    
    // Закрытие модального окна с видео
    function closeVideoModal() {
      videoModal.classList.remove('open');
      document.body.style.overflow = '';
      apartmentVideo.pause();
      apartmentVideo.currentTime = 0;
      
      // Сбрасываем размеры модального окна
      videoModalContent.style.width = '';
      videoModalContent.style.height = '';
    }
    
    // Обработчики событий для видео
    videoPreview.addEventListener('click', openVideoModal);
    playButton.addEventListener('click', function(e) {
      e.stopPropagation();
      openVideoModal();
    });
    
    videoModalClose.addEventListener('click', closeVideoModal);
    videoModal.addEventListener('click', function(e) {
      if (e.target === videoModal) {
        closeVideoModal();
      }
    });
    
    // Закрытие по клавише Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && videoModal.classList.contains('open')) {
        closeVideoModal();
      }
    });
    
    // Управление модальным окном цен
    const priceModal = document.getElementById('priceModal');
    const priceModalClose = document.getElementById('priceModalClose');
    const priceLink = document.getElementById('priceLink');
    const priceLinkFooter = document.getElementById('priceLinkFooter');
    const monthBoxes = document.querySelectorAll('.month-box');
    const messageField = document.getElementById('message');
    let lastSelectedMonth = '';
    
    // Открытие модального окна цен
    function openPriceModal() {
      priceModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    // Закрытие модального окна цен
    function closePriceModal() {
      priceModal.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    // Обработчики для открытия модального окна
    priceLink.addEventListener('click', function(e) {
      e.preventDefault();
      openPriceModal();
    });
    
    if (priceLinkFooter) {
      priceLinkFooter.addEventListener('click', function(e) {
        e.preventDefault();
        openPriceModal();
      });
    }
    
    // Обработчик для закрытия модального окна
    priceModalClose.addEventListener('click', closePriceModal);
    
    // Закрытие при клике вне окна
    priceModal.addEventListener('click', function(e) {
      if (e.target === priceModal) {
        closePriceModal();
      }
    });
    
    // Закрытие по клавише Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && priceModal.classList.contains('open')) {
        closePriceModal();
      }
    });
    
    // Функция для получения первого и последнего дня месяца в 2026 году
    function getMonthDates(monthName) {
      const monthMap = {
        'Январь': { first: '2026-01-01', last: '2026-01-31' },
        'Февраль': { first: '2026-02-01', last: '2026-02-28' },
        'Март': { first: '2026-03-01', last: '2026-03-31' },
        'Апрель': { first: '2026-04-01', last: '2026-04-30' },
        'Май': { first: '2026-05-01', last: '2026-05-31' },
        'Июнь': { first: '2026-06-01', last: '2026-06-30' },
        'Июль': { first: '2026-07-01', last: '2026-07-31' },
        'Август': { first: '2026-08-01', last: '2026-08-31' },
        'Сентябрь': { first: '2026-09-01', last: '2026-09-30' },
        'Октябрь': { first: '2026-10-01', last: '2026-10-31' },
        'Ноябрь': { first: '2026-11-01', last: '2026-11-30' },
        'Декабрь': { first: '2026-12-01', last: '2026-12-31' }
      };
      
      return monthMap[monthName] || { first: '', last: '' };
    }
    
    // Обработчики для месяцев - переход к форме бронирования с предустановкой дат
    monthBoxes.forEach(function(monthBox) {
      monthBox.addEventListener('click', function() {
        const month = this.getAttribute('data-month');
        lastSelectedMonth = month;
        closePriceModal();
        
        // Получаем даты для выбранного месяца
        const monthDates = getMonthDates(month);
        
        // Прокрутка к форме бронирования
        setTimeout(function() {
          const bookingFormSection = document.getElementById('booking-form');
          if (bookingFormSection) {
            bookingFormSection.scrollIntoView({ behavior: 'smooth' });
            
            // Устанавливаем даты в форме бронирования
            if (monthDates.first && monthDates.last) {
              const checkinInput = document.getElementById('checkin');
              const checkoutInput = document.getElementById('checkout');
              
              checkinInput.value = monthDates.first;
              
              // Устанавливаем минимальную дату для выезда (не менее чем через 2 дня после заезда)
              const checkinDate = new Date(monthDates.first);
              const minCheckoutDate = new Date(checkinDate);
              minCheckoutDate.setDate(minCheckoutDate.getDate() + 2);
              
              // Если последний день месяца меньше минимальной даты, используем минимальную дату
              const lastDay = new Date(monthDates.last);
              if (lastDay < minCheckoutDate) {
                checkoutInput.value = minCheckoutDate.toISOString().split('T')[0];
              } else {
                checkoutInput.value = monthDates.last;
              }
              
              // Устанавливаем минимальное значение для выезда
              checkoutInput.min = minCheckoutDate.toISOString().split('T')[0];
            }
            
            // Обновление текста в поле сообщения (замена, а не добавление)
            if (messageField) {
              // Удаляем предыдущее упоминание месяца, если оно есть
              const currentValue = messageField.value;
              const monthRegex = /Интересует бронирование в [А-Яа-я]+\.?\s*/g;
              const cleanedValue = currentValue.replace(monthRegex, '');
              
              // Добавляем новое упоминание месяца
              const monthText = `Интересует бронирование в ${month}. `;
              messageField.value = monthText + cleanedValue;
              messageField.focus();
              
              // Прокручиваем к полю сообщения
              setTimeout(() => {
                messageField.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 100);
            }
          }
        }, 300);
      });
    });
    
    // Lightbox для галереи
    const lightbox = document.getElementById('lightbox');
    const lightboxSlides = document.getElementById('lightboxSlides');
    const lightboxClose = document.getElementById('lightboxClose');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const lightboxCounter = document.getElementById('lightboxCounter');
    const zoomInButton = document.getElementById('zoomIn');
    const zoomOutButton = document.getElementById('zoomOut');
    const resetZoomButton = document.getElementById('resetZoom');
    const galleryItems = document.querySelectorAll('.gallery-item');
    
    let currentImageIndex = 0;
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    let currentScale = 1;
    let currentTranslate = { x: 0, y: 0 };
    let initialTouchesDistance = 0;
    
    // Создаем слайды для lightbox
    function createSlides() {
      lightboxSlides.innerHTML = '';
      galleryItems.forEach((item, index) => {
        const slide = document.createElement('div');
        slide.className = 'lightbox-slide';
        if (index === currentImageIndex) slide.classList.add('active');
        
        const imageContainer = document.createElement('div');
        imageContainer.className = 'lightbox-image-container';
        
        const img = document.createElement('img');
        img.src = item.querySelector('img').src;
        img.alt = item.querySelector('img').alt;
        img.dataset.initialTransform = 'scale(1) translate(0, 0)';
        
        const caption = document.createElement('div');
        caption.className = 'lightbox-caption';
        caption.textContent = item.querySelector('.gallery-caption').textContent;
        
        imageContainer.appendChild(img);
        slide.appendChild(imageContainer);
        slide.appendChild(caption);
        lightboxSlides.appendChild(slide);
      });
      
      updateCounter();
      resetImageTransform();
    }
    
    // Обновление счетчика
    function updateCounter() {
      lightboxCounter.textContent = `${currentImageIndex + 1} / ${galleryItems.length}`;
    }
    
    // Сброс трансформации изображения
    function resetImageTransform() {
      currentScale = 1;
      currentTranslate = { x: 0, y: 0 };
      const activeImage = document.querySelector('.lightbox-slide.active img');
      if (activeImage) {
        activeImage.style.transform = `scale(1) translate(0, 0)`;
      }
    }
    
    // Показать определенный слайд
    function showSlide(index) {
      const slides = document.querySelectorAll('.lightbox-slide');
      slides.forEach(slide => slide.classList.remove('active'));
      
      currentImageIndex = index;
      if (currentImageIndex < 0) {
        currentImageIndex = galleryItems.length - 1;
      } else if (currentImageIndex >= galleryItems.length) {
        currentImageIndex = 0;
      }
      
      slides[currentImageIndex].classList.add('active');
      resetImageTransform();
      updateCounter();
    }
    
    // Открытие lightbox
    galleryItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        currentImageIndex = index;
        createSlides();
        lightbox.classList.add('open');
        document.body.style.overflow = 'hidden';
      });
    });
    
    // Закрытие lightbox
    lightboxClose.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    
    // Навигация
    prevButton.addEventListener('click', (e) => {
      e.stopPropagation();
      showSlide(currentImageIndex - 1);
    });
    
    nextButton.addEventListener('click', (e) => {
      e.stopPropagation();
      showSlide(currentImageIndex + 1);
    });
    
    // Управление масштабированием
    zoomInButton.addEventListener('click', (e) => {
      e.stopPropagation();
      zoomImage(1.2);
    });
    
    zoomOutButton.addEventListener('click', (e) => {
      e.stopPropagation();
      zoomImage(0.8);
    });
    
    resetZoomButton.addEventListener('click', (e) => {
      e.stopPropagation();
      resetImageTransform();
    });
    
    function zoomImage(factor) {
      const activeImage = document.querySelector('.lightbox-slide.active img');
      if (activeImage) {
        currentScale *= factor;
        // Ограничиваем масштаб
        currentScale = Math.max(0.5, Math.min(currentScale, 5));
        activeImage.style.transform = `scale(${currentScale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;
      }
    }
    
    // Навигация с клавиатуры
    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('open')) return;
      
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showSlide(currentImageIndex - 1);
      if (e.key === 'ArrowRight') showSlide(currentImageIndex + 1);
    });
    
    // Закрытие lightbox
    function closeLightbox() {
      lightbox.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    // Обработка свайпов на мобильных устройствах
    lightbox.addEventListener('touchstart', handleTouchStart, false);
    lightbox.addEventListener('touchmove', handleTouchMove, false);
    lightbox.addEventListener('touchend', handleTouchEnd, false);
    
    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        isDragging = true;
      } else if (e.touches.length === 2) {
        // Масштабирование двумя пальцами
        e.preventDefault();
        initialTouchesDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        isDragging = false;
      }
    }
    
    function handleTouchMove(e) {
      if (e.touches.length === 1 && isDragging) {
        currentX = e.touches[0].clientX;
        
        // Предотвращаем скролл страницы при горизонтальном свайпе
        if (Math.abs(currentX - startX) > 10) {
          e.preventDefault();
        }
      } else if (e.touches.length === 2) {
        // Масштабирование двумя пальцами
        e.preventDefault();
        const currentDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        
        if (initialTouchesDistance > 0) {
          const zoomFactor = currentDistance / initialTouchesDistance;
          const activeImage = document.querySelector('.lightbox-slide.active img');
          
          if (activeImage) {
            currentScale *= zoomFactor;
            // Ограничиваем масштаб
            currentScale = Math.max(0.5, Math.min(currentScale, 5));
            activeImage.style.transform = `scale(${currentScale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;
            
            initialTouchesDistance = currentDistance;
          }
        }
      }
    }
    
    function handleTouchEnd(e) {
      if (e.touches.length < 1) {
        isDragging = false;
        
        if (e.changedTouches.length === 1) {
          const diffX = currentX - startX;
          
          // Определяем направление свайпа
          if (Math.abs(diffX) > 50) { // Минимальная дистанция для свайпа
            if (diffX > 0) {
              // Свайп вправо - предыдущее изображение
              showSlide(currentImageIndex - 1);
            } else {
              // Свайп влево - следующее изображение
              showSlide(currentImageIndex + 1);
            }
          }
        }
      }
      
      if (e.touches.length < 2) {
        initialTouchesDistance = 0;
      }
    }
    
    // Управление модальным окном правил проживания
    const rulesModal = document.getElementById('rulesModal');
    const rulesModalClose = document.getElementById('rulesModalClose');
    const rulesCloseBtn = document.getElementById('rulesCloseBtn');
    const rulesSubmitBtn = document.getElementById('rulesSubmitBtn');
    const rulesCheckboxContainer = document.getElementById('rulesCheckboxContainer');
    const rulesAgreement = document.getElementById('rulesAgreement');
    const rulesError = document.getElementById('rulesError');
    const viewRulesBtn = document.getElementById('viewRulesBtn');
    
    // Открытие модального окна правил в режиме просмотра (из меню или кнопки)
    function openRulesModalView() {
      // Скрываем чекбокс и кнопку отправки
      rulesCheckboxContainer.style.display = 'none';
      rulesSubmitBtn.style.display = 'none';
      rulesCloseBtn.style.display = 'block';
      rulesCloseBtn.textContent = 'Закрыть';
      
      // Сбрасываем состояние чекбокса
      rulesAgreement.checked = false;
      rulesError.classList.remove('visible');
      
      // Открываем модальное окно
      rulesModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    // Открытие модального окна правил в режиме подтверждения (из формы бронирования)
    function openRulesModalConfirm() {
      // Показываем чекбокс и кнопку отправки
      rulesCheckboxContainer.style.display = 'block';
      rulesSubmitBtn.style.display = 'block';
      rulesCloseBtn.style.display = 'block';
      rulesCloseBtn.textContent = 'Отмена';
      
      // Сбрасываем состояние чекбокса
      rulesAgreement.checked = false;
      rulesError.classList.remove('visible');
      
      // Открываем модальное окно
      rulesModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    // Закрытие модального окна правил
    function closeRulesModal() {
      rulesModal.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    // Обработчики для открытия модального окна правил в режиме просмотра
    const rulesMenuLinks = document.querySelectorAll('a[href="#rules"]');
    rulesMenuLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        openRulesModalView();
      });
    });
    
    if (viewRulesBtn) {
      viewRulesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        openRulesModalView();
      });
    }
    
    // Обработчики для закрытия модального окна правил
    rulesModalClose.addEventListener('click', closeRulesModal);
    rulesCloseBtn.addEventListener('click', closeRulesModal);
    
    rulesModal.addEventListener('click', function(e) {
      if (e.target === rulesModal) {
        closeRulesModal();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && rulesModal.classList.contains('open')) {
        closeRulesModal();
      }
    });
    
    // Обработка отправки формы через модальное окно правил
    rulesSubmitBtn.addEventListener('click', function() {
      if (!rulesAgreement.checked) {
        rulesError.classList.add('visible');
        return;
      }
      
      rulesError.classList.remove('visible');
      
      // Закрываем модальное окно правил
      closeRulesModal();
      
      // Отправляем форму
      if (pendingFormData) {
        sendEmail(pendingFormData);
      }
    });
    
    // Обработка формы бронирования и модального окна успеха
    const bookingForm = document.getElementById('bookingForm');
    const bookingSuccessModal = document.getElementById('bookingSuccessModal');
    const successModalClose = document.getElementById('successModalClose');
    const formMessage = document.getElementById('formMessage');
    const submitBtn = document.getElementById('submitBtn');
    const checkinInput = document.getElementById('checkin');
    const checkoutInput = document.getElementById('checkout');
    
    // Управление модальным окном успешного бронирования
    function openSuccessModal() {
      bookingSuccessModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSuccessModal() {
      bookingSuccessModal.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    successModalClose.addEventListener('click', closeSuccessModal);
    bookingSuccessModal.addEventListener('click', function(e) {
      if (e.target === bookingSuccessModal) {
        closeSuccessModal();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && bookingSuccessModal.classList.contains('open')) {
        closeSuccessModal();
      }
    });
    
    if (bookingForm) {
      // Установка минимальной даты (сегодня)
      const today = new Date().toISOString().split('T')[0];
      checkinInput.setAttribute('min', today);
      checkoutInput.setAttribute('min', today);
      
      // Функция для проверки минимального срока (2 дня)
      function validateStayDuration() {
        const checkinDate = new Date(checkinInput.value);
        const checkoutDate = new Date(checkoutInput.value);
        const timeDiff = checkoutDate.getTime() - checkinDate.getTime();
        const dayDiff = timeDiff / (1000 * 3600 * 24);
        
        return dayDiff >= 2;
      }
      
      // Обновление минимальной даты для выезда при изменении даты заезда
      checkinInput.addEventListener('change', function() {
        const checkinDate = this.value;
        const checkin = new Date(checkinDate);
        const minCheckout = new Date(checkin);
        minCheckout.setDate(minCheckout.getDate() + 2);
        
        checkoutInput.setAttribute('min', minCheckout.toISOString().split('T')[0]);
        
        // Если дата выезда раньше минимальной даты, устанавливаем минимальную дату
        if (checkoutInput.value < minCheckout.toISOString().split('T')[0]) {
          checkoutInput.value = minCheckout.toISOString().split('T')[0];
        }
      });
      
      // Валидация при изменении даты выезда
      checkoutInput.addEventListener('change', function() {
        if (!validateStayDuration()) {
          const checkinDate = new Date(checkinInput.value);
          const minCheckout = new Date(checkinDate);
          minCheckout.setDate(minCheckout.getDate() + 2);
          
          alert('Минимальный срок заселения - двое суток. Пожалуйста, выберите дату выезда не ранее ' + minCheckout.toLocaleDateString('ru-RU'));
          checkoutInput.value = minCheckout.toISOString().split('T')[0];
        }
      });
      
      // Отправка формы
      bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Проверка минимального срока проживания
        if (!validateStayDuration()) {
          showMessage('Минимальный срок заселения - двое суток. Пожалуйста, выберите более длительный период проживания.', 'error');
          return;
        }
        
        // Получаем данные формы
        pendingFormData = {
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          checkin: checkinInput.value,
          checkout: checkoutInput.value,
          guests: document.getElementById('guests').value,
          message: document.getElementById('message').value
        };
        
        // Валидация
        if (!pendingFormData.name || !pendingFormData.email || !pendingFormData.phone || !pendingFormData.checkin || !pendingFormData.checkout) {
          showMessage('Пожалуйста, заполните все обязательные поля', 'error');
          return;
        }
        
        // Валидация количества гостей (максимум 4)
        if (parseInt(pendingFormData.guests) > 4) {
          showMessage('Максимальное количество гостей - 4 человека', 'error');
          return;
        }
        
        // Блокируем кнопку отправки
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';
        
        // Открываем модальное окно правил в режиме подтверждения
        openRulesModalConfirm();
      });
    }
    
    // Функция показа сообщения
    function showMessage(text, type) {
      if (formMessage) {
        formMessage.textContent = text;
        formMessage.className = `form-message ${type} visible`;
        
        // Автоматическое скрытие через 5 секунд
        setTimeout(() => {
          formMessage.classList.remove('visible');
        }, 5000);
      }
    }
    
    // Функция отправки email через Formspree
    function sendEmail(formData) {
      // Используем Formspree для отправки email
      fetch('https://formspree.io/f/mjgblolk', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          checkin: formData.checkin,
          checkout: formData.checkout,
          guests: formData.guests,
          message: formData.message,
          _subject: 'Новая заявка на бронирование',
          _replyto: formData.email
        })
      })
      .then(response => {
        if (response.ok) {
          // Показываем модальное окно успеха
          openSuccessModal();
          // Сбрасываем форму
          bookingForm.reset();
          // Сбрасываем pendingFormData
          pendingFormData = null;
        } else {
          throw new Error('Ошибка отправки формы');
        }
      })
      .catch(error => {
        console.error('Ошибка:', error);
        showMessage('Произошла ошибка при отправке. Пожалуйста, попробуйте еще раз или свяжитесь с нами по телефону: +7 (978) 143-94-27', 'error');
      })
      .finally(() => {
        // Разблокируем кнопку отправки
        submitBtn.disabled = false;
        submitBtn.textContent = 'Отправить запрос';
      });
    }
  });
</script>
